(this.webpackJsonpari_stream_react_2=this.webpackJsonpari_stream_react_2||[]).push([[0],{29:function(e,n,t){},31:function(e,n,t){},32:function(e,n,t){"use strict";t.r(n);var o=t(8),a=t.n(o),r=t(16),c=t.n(r),i=t(9),s=t.n(i),l=t(11),d=t(17),u=t(18),f=t(20),p=t(19),h=t(14);h.a.initializeApp({apiKey:"AIzaSyBWPLx-DU9ANq9jqe3UsEYgFogpErlZAyw",authDomain:"aristream-87487.firebaseapp.com",databaseURL:"https://aristream-87487-default-rtdb.europe-west1.firebasedatabase.app"});var g=h.a.database(),m=function(e,n,t,o){g.ref("rooms/".concat(e,"/").concat(n)).set(t,(function(e){e||null===o||void 0===o||o(),console.log(e)}))},C=function(){var e=Object(l.a)(s.a.mark((function e(n){var t;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,g.ref("rooms/".concat(n)).get();case 2:if(!(t=e.sent).exists()){e.next=5;break}return e.abrupt("return",t.val());case 5:throw Error("READ DATA ERROR");case 6:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),v=(t(29),t(6)),S={iceServers:[{url:"stun:stun.l.google.com:19302"}]},O="host",b="client",j=function(e){Object(f.a)(t,e);var n=Object(p.a)(t);function t(e){var o;return Object(d.a)(this,t),(o=n.call(this,e)).clientUpdate=function(){var e,n=o.state,t=n.dataFromServer,a=n.isOffer;console.log("GET OFFER",t),(null===t||void 0===t||null===(e=t.host)||void 0===e?void 0:e.offer)&&!a&&(o.setState({isOffer:!0}),o.joinSession(t.host.offer))},o.hostUpdate=function(){var e,n=o.state,t=n.dataFromServer,a=n.isAnswer;(null===t||void 0===t||null===(e=t.client)||void 0===e?void 0:e.answer)&&!a&&(o.setState({isAnswer:!0}),o.completeHandshake(t.client.answer))},o.getPeerConnection=function(){console.log("getPeerConnection"),o.peerConnection=new RTCPeerConnection(S),o.peerConnection.onaddstream=o.gotRemoteStream,o.peerConnection.ondatachannel=function(e){o.channel=e.channel,o.channel.onopen=function(e){console.log("OPEN"),o.channel.onmessage=function(e){console.log("MESSAGE",e.data)}}},o.peerConnection.onicecandidate=o.gotIceCandidate,o.peerConnection.oniceconnectionstatechange=o.onConnectionStatusChange,o.peerConnection.onsignalingstatechange=function(e){console.log("Signaling change",e)}},o.getMediaStream=function(e){console.log("getMediaStream"),navigator.mediaDevices.getDisplayMedia({audio:!0,video:{width:1920,height:1080,frameRate:30}}).then((function(n){o.localStream=n,e(n)})).catch((function(e){console.log("getUserMedia error: ",e)}))},o.joinSession=function(e){console.log("joinSession"),null==o.peerConnection&&o.getPeerConnection(),""!==JSON.parse(e).desc?o.createAnswer(e):alert("Please enter the offer")},o.createOffer=function(e){console.log("create offer"),o.localVideo.current.srcObject=e,o.localVideo.current.muted=!0,o.peerConnection.addStream(e),o.peerConnection.createDataChannel("chat"),o.peerConnection.createOffer(o.onConnection,o.handleError)},o.initiateOffer=function(){console.log("initiateOffer"),null==o.peerConnection&&o.getPeerConnection(),o.getMediaStream(o.createOffer)},o.onConnection=function(e){console.log("Description is ",e),o.peerConnection.setLocalDescription(e),o.signalData.desc=e,o.handleJoin=function(){o.completeHandshake()}},o.createAnswer=function(e){console.log("create answer");var n=JSON.parse(e);o.peerConnection.setRemoteDescription(new RTCSessionDescription(n.desc),(function(){console.log("Success")}),o.handleError),o.peerConnection.createAnswer(o.sendReply,o.handleError),o.addIceCandidates(n.ice)},o.completeHandshake=function(e){console.log("Inside complete handshake");var n=e.trim();(n=JSON.parse(n)).desc?(o.peerConnection.setRemoteDescription(new RTCSessionDescription(n.desc),(function(){console.log("Success")}),o.handleError),o.addIceCandidates(n.ice)):alert("Please enter the answer")},o.sendReply=function(e){var n=o.state.roomInput;console.log("send reply"),o.peerConnection.setLocalDescription(e),o.signalData.desc=e,m(n,b,{answer:JSON.stringify(o.signalData)})},o.clearRoomThenStartSession=function(){var e,n,t=o.state,a=t.roomInput,r=t.role;e=a,n=Object(l.a)(s.a.mark((function e(){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:m(a,r,{offer:JSON.stringify(o.signalData)},(function(){o.setState({isHostReady:!0}),o.startCheckingServerData()}));case 1:case"end":return e.stop()}}),e)}))),g.ref("rooms/".concat(e)).set({},(function(e){e||n(),console.log(e)}))},o.startCheckingServerData=function(){var e=o.state.roomInput;o.updateServerTimer=setInterval(Object(l.a)(s.a.mark((function n(){var t;return s.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,C(e);case 2:t=n.sent,o.setState({dataFromServer:t});case 4:case"end":return n.stop()}}),n)}))),1e3)},o.gotIceCandidate=function(e){var n=o.state,t=n.roomInput,a=n.role;console.log("gotIceCandidate",e),e.candidate&&(o.signalData.ice.push(e.candidate),null!==o.timeOut&&clearTimeout(o.timeOut),o.timeOut=setTimeout((function(){t.length>0&&(a===O&&o.clearRoomThenStartSession(),o.setState({input:JSON.stringify(o.signalData)}))}),5e3))},o.addIceCandidates=function(e){for(var n in console.log("add ice candidates",e),e)o.peerConnection.addIceCandidate(new RTCIceCandidate(e[n]))},o.handleError=function(e){console.log("Error occured "+e)},o.closeCall=function(){console.log("close call"),o.peerConnection.close(),o.localVideo.current.pause(),o.remoteVideo.current.pause(),o.localStream=null},o.onConnectionStatusChange=function(e){switch(o.peerConnection.iceConnectionState){case"checking":console.log("Connecting to peer...");break;case"connected":console.log("Connection established."),clearInterval(o.updateServerTimer),o.updateServerTimer=null;break;case"disconnected":console.log("Disconnected."),o.closeCall();break;case"failed":console.log("Failed.");break;case"closed":console.log("Connection closed."),o.peerConnection=null,o.handleJoin=function(){o.joinSession()};break;default:console.log("sdfsfdsfsdfsdf")}},o.gotRemoteStream=function(e){console.log("Received remote stream"),o.remoteVideo.current.srcObject=e.stream},o.handleCall=function(){o.state.roomInput.length>0?o.initiateOffer():alert("ENTER ROOM ID")},o.handleJoin=function(){o.state.roomInput.length>0?o.startCheckingServerData():alert("ENTER ROOM ID")},o.setRole=function(e){o.setState({role:e})},o.renderMain=function(){var e,n,t=o.state,a=t.role,r=t.roomInput,c=t.isHostReady;return""!==a?Object(v.jsxs)(v.Fragment,{children:[Object(v.jsx)("input",{placeholder:"ROOM ID",value:r,onChange:function(e){return o.setState({roomInput:e.target.value})}}),a===O&&Object(v.jsxs)("div",{children:[Object(v.jsx)("button",{onClick:o.handleCall,disabled:c,children:c?"HOST READY":"call"}),Object(v.jsx)("button",{onClick:null===(e=o.channel)||void 0===e?void 0:e.send("message from HOST"),children:"send check"}),Object(v.jsx)("div",{children:Object(v.jsx)("video",{controls:!0,autoPlay:!0,ref:o.localVideo,width:300,height:300})})]}),a===b&&Object(v.jsxs)("div",{children:[Object(v.jsx)("button",{onClick:o.handleJoin,children:"join"}),Object(v.jsx)("button",{onClick:null===(n=o.channel)||void 0===n?void 0:n.send("message from CLIENT"),children:"send check"}),Object(v.jsx)("div",{children:Object(v.jsx)("video",{controls:!0,autoPlay:!0,ref:o.remoteVideo,width:300,height:300})})]})]}):null},o.state={input:"",role:"",roomInput:"",dataFromServer:{},isOffer:!1,isAnswer:!1,isHostReady:!1},o.signalData={desc:null,ice:[]},o.peerConnection=null,o.localVideo=a.a.createRef(null),o.remoteVideo=a.a.createRef(null),o.localStream=null,o.perfArr=[],o.lastPerfStamp=0,o.timeOut=null,o.updateServerTimer=null,o.channel=null,o}return Object(u.a)(t,[{key:"componentDidUpdate",value:function(){var e=this.state,n=e.role,t=e.dataFromServer;console.log("UPDATESERVER",t),n===b&&this.clientUpdate(),n===O&&this.hostUpdate()}},{key:"render",value:function(){var e=this;return Object(v.jsxs)("div",{className:"App",children:[Object(v.jsx)("button",{className:"button",onClick:function(){return e.setRole(O)},children:"Host"}),Object(v.jsx)("button",{className:"button",onClick:function(){return e.setRole(b)},children:"Client"}),this.renderMain()]})}}]),t}(o.Component);t(31);c.a.render(Object(v.jsx)(a.a.StrictMode,{children:Object(v.jsx)(j,{})}),document.getElementById("root"))}},[[32,1,2]]]);
//# sourceMappingURL=main.e5438e85.chunk.js.map